<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yonyou.scf.user.mapper.hand.UserMapper" >
  
  <!-- 客户名称获取 -->
  <select id="getUserNameList" resultType="Map" parameterType="map">
	select company_info.company_name as userName,company_info.user_id as userId
	from user_role,company_info
	where user_role.user_style = #{user_style_company,jdbcType=VARCHAR} 
	and user_role.user_id=company_info.user_id
	union all
	select user_info.user_name as userName,user_info.user_id as userId
	from user_role,user_info
	where user_role.user_style = #{user_style_person,jdbcType=VARCHAR} 
	and user_role.user_id=user_info.user_id
  </select>
  
  <!-- 证件号码获取 -->
  <select id="getCredentialNumList" resultType="Map" parameterType="map">
	select company_info.unified_social_credit_code as credentialNum,company_info.user_id as userId,company_info.three_examinations_to_one as credentialType
	from user_role,company_info
	where user_role.user_style = #{user_style_company,jdbcType=VARCHAR} 
	and user_role.user_id=company_info.user_id
	union all
	select user_info.credential_num as credentialNum,user_info.user_id as userId,user_info.credential_type as credentialType
	from user_role,user_info
	where user_role.user_style = #{user_style_person,jdbcType=VARCHAR} 
	and user_role.user_id=user_info.user_id
  </select>
  
  <!-- 客户信息检索 -->
  <select id="getUserInfoList" resultType="Map" parameterType="map">
  	select * from (
	select company_info.company_name as userName,
	company_info.user_id as userId,
	company_info.unified_social_credit_code as credentialNum,
	company_info.three_examinations_to_one as credentialType,
	user_role.user_style as userType,
	user_role.user_role as userRole,
	user_role.create_time as creatTime,
	company_info.enable_status as status
	from user_role,company_info
	where 
	user_role.user_id=company_info.user_id
	<if test="userType != null">
		AND user_role.user_style = #{userType,jdbcType=VARCHAR}
	</if>
	<if test="userRole != null">
		AND user_role.user_role = #{userRole,jdbcType=VARCHAR}
	</if>
	<if test="credentialNum != null">
		AND company_info.unified_social_credit_code = #{credentialNum,jdbcType=VARCHAR}
	</if>
	<if test="userName != null">
		AND company_info.company_name = #{userName,jdbcType=VARCHAR}
	</if>
	
	union all
	
	select user_info.user_name as userName,
	user_info.user_id as userId,
	user_info.credential_num as credentialNum, 
	user_info.credential_type as credentialType,
	user_role.user_style as userType,
	user_role.user_role as userRole,
	user_role.create_time as creatTime,
	user_info.enable_status as status
	from user_role,user_info
	where user_role.user_id=user_info.user_id
	<if test="userType != null">
		and user_role.user_style = #{userType,jdbcType=VARCHAR} 
	</if>
	<if test="userRole != null">
		AND user_role.user_role = #{userRole,jdbcType=VARCHAR}
	</if>
	<if test="credentialNum != null">
		AND user_info.credential_num = #{credentialNum,jdbcType=VARCHAR}
	</if>
	<if test="userName != null">
		AND user_info.user_name = #{userName,jdbcType=VARCHAR}
	</if>
	) A order by creatTime desc
  </select>
  
  <!-- 客户关系检索 -->
  <select id="getUserRelationshipList" resultType="Map" parameterType="map">
  
  select * from (
	select company_info.company_name as userName,
	company_info.user_id as userId,
	company_info.unified_social_credit_code as credentialNum,
	company_info.three_examinations_to_one as credentialType,
	user_role.user_style as userType,
	user_role.user_role as userRole,
	user_role.create_time as creatTime,
	company_info.enable_status as status
	from user_role,company_info
	where user_role.user_id=company_info.user_id
	<if test="userType != null">
		AND user_role.user_style = #{userType,jdbcType=VARCHAR}
	</if>
	<if test="userRole != null">
		AND user_role.user_role = #{userRole,jdbcType=VARCHAR}
	</if>
	<if test="credentialNum != null">
		AND company_info.unified_social_credit_code = #{credentialNum,jdbcType=VARCHAR}
	</if>
	<if test="userName != null">
		AND company_info.company_name = #{userName,jdbcType=VARCHAR}
	</if>
	
	union all
	
	select user_info.user_name as userName,
	user_info.user_id as userId,
	user_info.credential_num as credentialNum, 
	user_info.credential_type as credentialType,
	user_role.user_style as userType,
	user_role.user_role as userRole,
	user_role.create_time as creatTime,
	user_info.enable_status as status
	from user_role,user_info
	where user_role.user_id=user_info.user_id
	<if test="userType != null">
		and user_role.user_style = #{userType,jdbcType=VARCHAR} 
	</if>
	<if test="userRole != null">
		AND user_role.user_role = #{userRole,jdbcType=VARCHAR}
	</if>
	<if test="credentialNum != null">
		AND user_info.credential_num = #{credentialNum,jdbcType=VARCHAR}
	</if>
	<if test="userName != null">
		AND user_info.user_name = #{userName,jdbcType=VARCHAR}
	</if>
	) A
	order by userType,userRole
	
  </select>
  
  <!-- 通过某资方检索所有相关方 -->
  <select id="getRelationshipList2" resultType="Map" parameterType="map">
  select distinct a.id as id,a.companyRole as companyRole
	from(
	SELECT
	    c1.company_id2   AS id,
	    c1.company_role2 AS companyRole
	FROM
	    company_relationship c1
	WHERE
	 c1.company_role = '2'
	 	<if test="companyId != null">
	 		 AND   c1.company_id = #{companyId,jdbcType=VARCHAR}
		</if>
	AND c1.enable_status = '0'
	UNION ALL
	SELECT
	    c2.company_id2   AS id,
	    c2.company_role2 AS companyRole
	FROM
	    company_relationship c2
	WHERE
	    c2.enable_status = '0'
	AND c2.company_id IN
	    (
	        SELECT
	            c3.company_id
	        FROM
	            company_relationship c3
	        WHERE
	        c3.company_role2 = '1'
		 	<if test="companyId != null">
		 		 AND   c3.company_id2 = #{companyId,jdbcType=VARCHAR}
			</if>
	        AND c3.enable_status = '0')
	        ) a
	        order by a.companyRole
          </select>
</mapper>