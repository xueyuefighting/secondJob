package com.yonyou.scf.common.helper;

import com.yonyou.scf.common.constant.MessengerErrorMsgConstants;
import com.yonyou.scf.common.constant.URLConst;
import com.yonyou.scf.common.output.ResultBean;
import com.yonyou.scf.common.system.CodeException;
import com.yonyou.scf.common.tx.api.TxRequest;
import com.yonyou.scf.common.tx.api.TxResponse;
import com.yonyou.scf.common.tx.mail.MailSend;
import com.yonyou.scf.common.util.CreateID;
import com.yonyou.scf.common.util.StringUtil;
import com.yonyou.scf.common.util.json.JsonUtil;
import com.yonyou.scf.common.util.net.HttpClientUtil;

/**
 * 
 * 对接Mail模块的发送接口，进行测试。
 *
 */
public class MailHelper {

	public static String mail_url = "http://test2.yonyouscf.com/Mail";

	public static Boolean doSend(String platformId, String mailAddr, String subject, String text, String txNo) throws CodeException {

		ResultBean rb = new ResultBean();

		try {

			// 业务数据
			MailSend me = new MailSend();
			me.setTxNo(CreateID.getRandomCharAndNumber(32, false));
			me.setMailTo(mailAddr);
			me.setSubject(subject);
			me.setText(text);

			System.out.println("SMSHelper:request:" + me.toString());

			// TODO:签名 + 组装
//			TxRequest txReq = new TxRequest(JsonUtil.toJSONString(me), SignatureHelper.doSignToSig(me));
//			txReq.setPlatformId(platformId);
//			txReq.setUrlParam("Mail");
//			txReq.setInterfaceNo("5000");
			// System.out.println("SMSHelper:request:" + txReq.toString());

			/**
			 * 以下内容可继续提炼为共同方法
			 */
			// 发送报文 + 接收返回
			String responseText = HttpClientUtil.post(URLConst.URL_MAIL + "/Send", me);
//			System.out.println("SMSHelper:responseText:" + responseText);
//			TxResponse txRes = new TxResponse(responseText);
//			// TxResponse txRes = TxMessenger.send(txReq);
//
//			if (null == txRes || StringUtil.isEmpty(txRes.getJsonSignature()) || null == txRes.getJsonMessage()) {
//				throw new CodeException("2001", "返回解析异常");
//			}
//			// 验签，失败时抛出异常
//			SignatureHelper.doVerify(txRes, "00000000");
//			// Verify.doVerify(txRes);
//			// 解析
//			rb = txRes.getJsonMessage();
			
			rb = JsonUtil.toBean(responseText, ResultBean.class);

			System.out.println("SMSHelper:response:" + rb.toString());

//		} catch (CodeException ce) {
//			ce.printStackTrace();
//			throw ce;
		} catch (Exception e) {
			System.out.println("ERROR : " + e.toString());
			e.printStackTrace();
			throw new CodeException(MessengerErrorMsgConstants.ERR_2001_CODE, MessengerErrorMsgConstants.ERR_2001_MSG);
		}

		return true;

		// return rb;
	}

}
