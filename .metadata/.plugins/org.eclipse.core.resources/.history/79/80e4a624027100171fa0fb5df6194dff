<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="yonyou.scf.mapper.CombineToPaltformMapper" >
 <select id="getInfoAgencyByPage" resultType="map" parameterType="map">
 	SELECT * from (SELECT fp.systemid,fg.platform_id platformid,(SELECT platform_name from platform_info WHERE platform_id=fg.PLATFORM_ID) AS platformname,fp.fs_id fsid,fp.fs_name fsname,fp.fs_group_no fsgroupno,

(CASE fp.fs_type WHEN 10 THEN '自然人' WHEN 20 THEN '企业' ELSE '不存在的类型' END) AS fstypename,

fg.center_company_name AS companyname,

(SELECT COUNT(systemid) FROM user_combine_status WHERE user_role=20 AND platform_id=fg.platform_id and merchant_user_id=fp.fs_id) AS  agencycombinestatus,fg.center_company_id companyid,
 
fg.batch_no batchno,(CASE (SELECT COUNT(systemid) FROM user_combine_status WHERE user_role=20 AND platform_id=fg.platform_id and merchant_user_id=fp.fs_id) 

WHEN 0 THEN '未关联' WHEN 1 THEN '已关联' ELSE '多次关联' END) agencycombinestr,
 
(case IFNULL(uucs.USER_ENABLE_STATUS,0) when 0 then 0 else 1 end)  companynamestatus,fp.create_time createtime
 
FROM (fit_persional_information fp , fi_group fg) left join user_combine_status uucs on fp.FS_ID=uucs.MERCHANT_USER_ID

where  fp.fi_group_id = fg.systemid and ((uucs.`USER_ENABLE_STATUS` is null) or (uucs.`DMT_USER_ID`=#{agencyid,jdbcType=VARCHAR} and uucs.`USER_ENABLE_STATUS` is not null))  and uucs.USER_ROLE=20 
    
    <if test="agencyName!=null and agencyName!=''">
    	AND fp.fs_name LIKE #{agencyName,jdbcType=VARCHAR}
    </if>
    <if test="agencyType!=0">
    	AND fp.fs_type = #{agencyType,jdbcType=INTEGER}
    </if>
    <if test="agencyCode!=null and agencyCode!=''">
    	AND fp.fs_group_no like #{agencyCode,jdbcType=VARCHAR}
    </if>
    
    ) result WHERE 1=1 
    
    ##AND agencycombinestatus=0
    
    <if test="platformName!=null and platformName!=''">
    	AND result.platformname like #{platformName,jdbcType=VARCHAR}
    </if>
    
    ORDER BY agencycombinestatus DESC,createtime,fsid
    
 </select>
 
 <select id="getInfoByCompanyByPage" resultType="map" parameterType="map">
 	SELECT fi.systemid,fi.`PLATFORM_ID` platformid,pla.`PLATFORM_NAME` platformname,

	fi.`BATCH_NO` batchno,fi.`CENTER_COMPANY_GROUP_NUM` companygroupno,fi.`CENTER_COMPANY_ID` centercompanyid,

	fi.`CENTER_COMPANY_NAME` centercompanyname,(CASE IFNULL(ucs.`USER_ENABLE_STATUS`,0) WHEN 0 THEN '未关联' ELSE '已关联' END) AS combinestr ,

	(CASE WHEN ucs.`USER_ENABLE_STATUS` IS NULL THEN 0 ELSE 1 END) AS combinestatus,fi.`CREATE_TIME` createtime

	FROM fi_group fi 

	LEFT JOIN user_combine_status ucs ON fi.`CENTER_COMPANY_ID`=ucs.`MERCHANT_USER_ID` 
	
	AND ucs.`USER_ROLE`=10 AND ucs.`PLATFORM_ID`=fi.`PLATFORM_ID` 
	
	LEFT JOIN platform_info pla ON fi.`PLATFORM_ID`=pla.`PLATFORM_ID`

	where ((ucs.`USER_ENABLE_STATUS` is null) or (ucs.`DMT_USER_ID`=#{companyid,jdbcType=VARCHAR} and ucs.`USER_ENABLE_STATUS` is not null) )
	    
    <if test="platformName!=null">
    	AND pla.`PLATFORM_NAME` like #{platformName,jdbcType=VARCHAR}
    </if>
    <if test="companyName!=null">
    	AND fi.`CENTER_COMPANY_NAME` like #{companyName,jdbcType=VARCHAR}
    </if>
    <if test="companyCode!=null">
    	AND fi.`CENTER_COMPANY_GROUP_NUM` like #{companyCode,jdbcType=VARCHAR}
    </if>
    
    ORDER BY combinestatus DESC,createtime,centercompanyid
 </select>
</mapper>