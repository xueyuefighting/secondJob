package com.yonyou.scf.gateway.impl;

import java.io.IOException;
import java.io.InputStream;
import java.math.BigDecimal;
import java.util.List;
import java.util.Properties;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.yonyou.scf.common.helper.MessengerHelper;
import com.yonyou.scf.common.schema1.domain.Capital;
import com.yonyou.scf.common.schema1.domain.Finance;
import com.yonyou.scf.common.schema1.domain.FinancingApplication;
import com.yonyou.scf.common.schema1.domain.FinancingApplicationExample;
import com.yonyou.scf.common.schema1.domain.PlatformInfo;
import com.yonyou.scf.common.schema1.domain.Product;
import com.yonyou.scf.common.schema1.mapper.CapitalMapper;
import com.yonyou.scf.common.schema1.mapper.FinancingApplicationMapper;
import com.yonyou.scf.common.schema1.mapper.PlatformInfoMapper;
import com.yonyou.scf.common.schema1.mapper.ProductMapper;
import com.yonyou.scf.common.tx.api.ResultBean;
import com.yonyou.scf.common.tx.notice.Scf1108NoticeRequest;
import com.yonyou.scf.common.tx.notice.Scf1118NoticeRequest;
import com.yonyou.scf.common.tx.notice.Scf1208NoticeRequest;
import com.yonyou.scf.gateway.interf.INoticeMsgByAgency;
import com.yonyou.scf.tools.constant.DefaultConstants;
import com.yonyou.scf.tools.system.CodeException;
import com.yonyou.scf.tools.util.StringUtil;
import com.yonyou.scf.tools.util.TimeUtil;
@Service("noticeMsgByAgency")
public class NoticeMsgByAgency implements INoticeMsgByAgency{
	
	private volatile String platformId;
	
	//贷前准备状态
	private final static int BEFORE_LOAN_STATUS_20 = 20;
	//贷前准备已完成
	private final static int BEFORE_LOAN_STATUS_40 = 40;
	
	//融资申请变更状态
	public final static int APPLICATION_BILL_STATUS_20 = 20;//审核中
	public final static int APPLICATION_BILL_STATUS_30 = 30;//申请失败
	public final static int APPLICATION_BILL_STATUS_40 = 40;//融资成功
	public final static int APPLICATION_BILL_STATUS_20_T = 20;//审核中  _T 表
	public final static int APPLICATION_BILL_STATUS_31_T = 31;//申请失败
	public final static int APPLICATION_BILL_STATUS_32_T = 32;//融资成功
	
	public final static String agencyAdminRole = "ROLE88888888";//融资方超管
	public final static String companyAdminRole = "ROLE88888888";//融资成功
	
	//利率精度
	public final static int NUMBER_PRECISION = 1000000;
	
	@Autowired
	CapitalMapper capitalMapper;
	@Autowired
	PlatformInfoMapper platformInfoMapper;
	@Autowired
	ProductMapper productMapper; 
	@Autowired
	FinancingApplicationMapper financingApplicationMapper;
	
	/*
	 * 发送融资服务开通成功通知
	 * @param merchantUserId
	 * @param product
	 * @throws Exception
	 * @throws CodeException
	 */
	public  void noticeMsgByAgencyFor1108Or1118(String merchantUserId, Product product, String platformId) throws Exception,
			CodeException {
		
		this.platformId = platformId;
		
		PlatformInfo platformInfo = getPlatformEntity();
		
		String productCapitalId = product.getProductCapitalId();
		
		String theTypeOfBank = judgeTypeOfBank(productCapitalId);
		
		//1.2如果是非签约银行,发SCF1118
		if("underLine".equals(theTypeOfBank)){
			sendSCF1118(merchantUserId, product, platformInfo);
		}else{//1.1如果是签约银行，发SCF1108
			sendSCF1108(merchantUserId, product, platformInfo);
		}
	}

	public PlatformInfo getPlatformEntity() throws Exception {
		//获取当前系统渠道方systemid
		String platformSystemId = getPaltformInfo();
		
		if(platformSystemId==null){
			throw new Exception("获取渠道方主键id有误");
		}
		
		PlatformInfo platformInfo = platformInfoMapper.selectByPrimaryKey(platformSystemId);
		return platformInfo;
	}

	public void sendSCF1108(String merchantUserId, Product product,
			PlatformInfo platformInfo)
			throws CodeException {
		
		if(platformInfo==null){
			try {
				platformInfo = getPlatformEntity();
			} catch (Exception e) {
				e.printStackTrace();
				throw new CodeException(e.getMessage());
			}
		}
		
		final Scf1108NoticeRequest scf1108 = new Scf1108NoticeRequest();
		int typeInt = 20;//信用融资
		//下面如果是换oms 换库 是必须要改动的
		if("01".equals(product.getProductMode())){//订单融资
			typeInt = 10;
		}
		
		scf1108.setFundId(product.getProductCapitalId());
		scf1108.setProductId(product.getProductId());
		scf1108.setProductName(product.getProductName());
		scf1108.setBeforeLoanStatus(BEFORE_LOAN_STATUS_20);
		scf1108.setCenterCompanyId(product.getProductCompanyId());
		scf1108.setFsManagedAccountBankID("0000");
		scf1108.setFsManagedAccountNumber("0000");
		
		scf1108.setFinanceProductionType(typeInt);
		scf1108.setFsId(merchantUserId);
		
		final PlatformInfo platformInf = platformInfo;
		
		new Thread(new Runnable() {
			
			@Override
			public void run() {
				ResultBean rb = new ResultBean();
				try {
					rb = MessengerHelper.doSend(platformInf.getPlatformId(),
							DefaultConstants.API_SCF1108, 2, platformInf.getInformUrl(), scf1108);
				} catch (CodeException e) {
					e.printStackTrace();
				}
				System.out.println("发送通知返回值:"+rb.toString());
			}
		}).start();
	}

	/**
	 * @param merchantUserId 商户端用户id
	 * @param product 产品
	 * @param platformInfo 平台信息
	 * @param typeInt 融资类型
	 * @throws CodeException
	 */
	public void sendSCF1118(String merchantUserId, Product product,
			PlatformInfo platformInfo) throws CodeException {
		
		if(platformInfo==null){
			try {
				platformInfo = getPlatformEntity();
			} catch (Exception e) {
				e.printStackTrace();
				throw new CodeException(e.getMessage());
			}
		}
		
		int typeInt = 20;//信用融资
		//下面如果是换oms 换库 是必须要改动的
		if("01".equals(product.getProductMode())){//订单融资
			typeInt = 10;
		}
		final Scf1118NoticeRequest scf1118 = new Scf1118NoticeRequest();
		scf1118.setFundId(product.getProductCapitalId());
		scf1118.setProductId(product.getProductId());
		scf1118.setProductName(product.getProductName());
		scf1118.setBeforeLoanStatus(BEFORE_LOAN_STATUS_40);
		scf1118.setCenterCompanyId(product.getProductCompanyId());
		scf1118.setFinanceProductionType(typeInt);
		scf1118.setFsId(merchantUserId);
		final PlatformInfo platformInf = platformInfo;
		
		new Thread(new Runnable() {
			
			@Override
			public void run() {
				ResultBean rb = new ResultBean();
				try {
					rb = MessengerHelper.doSend(platformInf.getPlatformId(),
							DefaultConstants.API_SCF1118, 2, platformInf.getInformUrl(), scf1118);
				} catch (CodeException e) {
					e.printStackTrace();
				}
				System.out.println("发送通知返回值:"+rb.toString());
			}
		}).start();
	}
	
	/*
	 * 判断银行的类型
	 * @return online 线上；underLine 线下
	 */
	public String judgeTypeOfBank(String capitalId) throws Exception {
		Capital capital = capitalMapper.selectByPrimaryKey(capitalId);
		
		if(capital==null){
			throw new Exception("获取资方信息有误");
		}
		
		String capitalBankid = capital.getCapitalBankid();
		
		if("0".equals(capitalBankid)){
			return "underLine";
		}
		
		return "onLine";
	}
	
	public String getPaltformInfo() {
		
		if(!StringUtil.isEmpty(this.platformId)){
			return this.platformId;
		}
		
		InputStream in  = NoticeMsgByAgency.class.getClassLoader().getResourceAsStream("config.properties");
		Properties p = new Properties();
		try {
			p.load(in);
			return p.getProperty("merchant.platformInfo.systemId");
		} catch (IOException e) {
			e.printStackTrace();
			return null;
		}finally{
			if(in!=null){
				try {
					in.close();
				} catch (IOException e) {
					e.printStackTrace();
					return null;
				}
			}
		}
	}

	/* 
	 * 融资申请状态变更通知
	 * @see com.bjdreamtech.service.INoticeMsgByAgency#sendSCF1208(java.lang.String, com.bjdreamtech.entity.Product, yonyou.scf.bean.PlatformInfo)
	 */
	@Override
	public void sendSCF1208(Finance finance,
			PlatformInfo platformInfo, int status) throws CodeException {
		
		if(platformInfo==null){
			try {
				platformInfo = getPlatformEntity();
			} catch (Exception e) {
				e.printStackTrace();
				throw new CodeException(e.getMessage());
			}
		}
		
		final Scf1208NoticeRequest scf1208 = new Scf1208NoticeRequest();
		
		Product product =  productMapper.selectByPrimaryKey(finance.getFinanceProductId());
		
		FinancingApplicationExample example = new FinancingApplicationExample();
		example.createCriteria().andFinancingIdEqualTo(finance.getFinanceId());
		
		List<FinancingApplication> financingApplicationList = financingApplicationMapper.selectByExample(example);
		
		if(financingApplicationList==null || financingApplicationList.size()<=0 || financingApplicationList.size()>1){
			throw new CodeException("商户端融资申请单数据有误，请联系运营人员");
		}
		
		FinancingApplication financingApplication = financingApplicationList.get(0);
		
		scf1208.setApplicationBillStatus(status);
		scf1208.setBillNo(financingApplication.getBillNo());
		scf1208.setCenterCompanyID(product.getProductCompanyId());
		scf1208.setFinanceAmount(finance.getFinanceAmount().multiply(new BigDecimal(100)).intValue());
		scf1208.setFinanceProductionInterest(getInt(product.getProductRate()));
		scf1208.setFinanceProductionType(financingApplication.getFinanceProductionType());
		scf1208.setFinancingApplicationNo(financingApplication.getFinancingApplicationNo());
		scf1208.setFsID(financingApplication.getFsId());
		scf1208.setFundID(product.getProductCapitalId());
		scf1208.setOverdueInterest(getInt(product.getProductOverrate()));

		//		scf1208.setRepayWay(product.getProductRepaytype());
		
		final PlatformInfo platformInf = platformInfo;
		
		new Thread(new Runnable() {
			
			@Override
			public void run() {
				ResultBean rb = new ResultBean();
				try {
					rb = MessengerHelper.doSend(platformInf.getPlatformId(),
							DefaultConstants.API_SCF1208, 2, platformInf.getInformUrl(), scf1208);
					System.out.println("发送通知返回值:"+rb.toString());
				} catch (CodeException e) {
					e.printStackTrace();
				}
				System.out.println("发送通知返回值:"+rb.toString());
			}
		}).start();
	}
	
	public static int getInt(BigDecimal bd){
		BigDecimal aa = bd.multiply(new BigDecimal(1000000/100));
		int result = (int)aa.doubleValue();
		return result;
	}
	
	/*
	 * 更改商户端融资单状态位
	 * @param finance
	 * @return
	 */
	public  int updIntoPlatFormTable(Finance finance, int state) {
		FinancingApplicationExample example = new FinancingApplicationExample();
		example.createCriteria().andFinancingIdEqualTo(finance.getFinanceId());
		
		List<FinancingApplication> financingApplicationList = financingApplicationMapper.selectByExample(example);
		
		if(financingApplicationList==null || financingApplicationList.size()<=0 || financingApplicationList.size()>1){
			return 0;
		}
		
		FinancingApplication financingApplication = financingApplicationList.get(0);
		
		String systime =  TimeUtil.getTimeMillisecondStamp();  //获取服务器时间
		
		financingApplication.setModifyTime(systime);
		financingApplication.setBillStatus(state);
		
		return financingApplicationMapper.updateByPrimaryKey(financingApplication);
		
	}

}
